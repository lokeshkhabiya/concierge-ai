generator client {
  provider = "prisma-client"
  output   = "../generated"
  moduleFormat = "esm"
  runtime = "bun"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  preferences UserPreference[]
  sessions    Session[]
}

model UserPreference {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @db.Uuid
  preferenceKey   String
  preferenceValue Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @db.Uuid
  sessionType String
  status      String
  context     Json?
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime  @default(now())

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations  Conversation[]
  tasks          Task[]
}

model Conversation {
  id               String   @id @default(uuid()) @db.Uuid
  sessionId        String   @db.Uuid
  conversationType String
  metadata         Json?
  createdAt        DateTime @default(now())

  session  Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  messages Message[]
}

model Message {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @db.Uuid
  role           String
  content        String   @db.Text
  metadata       Json?
  sequenceNumber Int
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Task {
  id             String    @id @default(uuid()) @db.Uuid
  sessionId      String    @db.Uuid
  taskType       String
  status         String
  phase          String
  gatheredInfo   Json?
  executionPlan  Json?
  progress       Float?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  completedAt    DateTime?

  session      Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  taskResults  TaskResult[]
  taskSteps    TaskStep[]
}

model TaskResult {
  id              String   @id @default(uuid()) @db.Uuid
  taskId          String   @db.Uuid
  resultType      String
  data            Json?
  formattedResult String?  @db.Text
  createdAt       DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model TaskStep {
  id             String    @id @default(uuid()) @db.Uuid
  taskId         String    @db.Uuid
  stepName       String
  status         String
  inputData      Json?
  outputData     Json?
  sequenceNumber Int
  startedAt      DateTime?
  completedAt    DateTime?

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}
